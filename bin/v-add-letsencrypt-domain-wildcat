#!/usr/bin/env sh
#!/bin/bash
# info: adding letsencrypt ssl cetificate for domain
# options: USER DOMAIN [RESTART] [NOTIFY]
#
# The function turns on SSL support for a domain. Parameter ssl_dir is a path
# to directory where 2 or 3 ssl files can be found. Certificate file
# domain.tld.crt and its key domain.tld.key  are mandatory. Certificate
# authority domain.tld.ca file is optional. If home directory  parameter
# (ssl_home) is not set, https domain uses public_shtml as separate
# documentroot directory.

# also, heres the guide uri:
# http://strugglers.net/~andy/blog/2018/03/19/lets-encrypt-wildcard-certificates-acme-sh-and-automated-dns-verification/

#----------------------------------------------------------#
#                    Variable&Function                     #
#----------------------------------------------------------#

# Argument definition
user=$1
domain=$2
aliases="*.$2"
restart=$3
notify=$4

#echo $aliases;
#exit 0;
# Includes
source $VESTA/func/main.sh
source $VESTA/func/domain.sh
source $VESTA/conf/vesta.conf

# Additional argument formatting
format_domain_idn
get_file_line(){
file=$1
find=$2
while IFS= read -r var
do
        if [[ "$var" =~ "$2" ]]; then
                echo "$var";
                return 1;
        fi;
done < "$file"
}
remove_substring(){
        string="$1"
        find="$2"
        test=${string#"$find"};
        echo "$test";
}
#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

check_args '2' "$#" 'USER DOMAIN [RESTART] [NOTIFY]'
is_format_valid 'user' 'domain'
is_system_enabled "$WEB_SYSTEM" 'WEB_SYSTEM'
is_system_enabled "$WEB_SSL" 'SSL_SUPPORT'
is_object_valid 'user' 'USER' "$user"
is_object_unsuspended 'user' 'USER' "$user"
is_object_valid 'web' 'DOMAIN' "$domain"
is_object_unsuspended 'web' 'DOMAIN' "$domain"


#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

if [ ! -e "$VESTA/acme" ]; then
        $(mkdir -p "$VESTA/acme" );
fi;
cd "$VESTA/acme";
output="";
if [ ! -e "$VESTA/acme/acme.sh" ]; then
        mkdir "$VESTA/acme/installer/" -p && cd  "$VESTA/acme/installer/";
        $(git clone https://github.com/Neilpang/acme.sh.git)
        ls -la "$VESTA/acme/"
        export INSTALLONLINE=1
        wget "https://raw.githubusercontent.com/Neilpang/acme.sh/master/acme.sh"
        sudo bash ./acme.sh --install --home "$VESTA/acme/"
        #sudo $VESTA/acme/installer/acme.sh/acme.sh --install --home  $VESTA/acme/ --config-home  $VESTA/acme/data --certhome   $VESTA/acme/certs
fi;

# Get the user contact Email
data_mail=$($VESTA/bin/v-get-user-value "$user" "CONTACT");


# ADD CAA's RECORD
CAA=$($VESTA/bin/v-exists-dns-record "$user" "$domain" "$domain" "CAA")
if [ "$CAA" = "0" ]; then
        CAA2=$($VESTA/bin/v-exists-dns-record "$user" "$domain" "$domain" "CAA")
        if [ "$CAA2" = "0" ]; then
                # $VESTA/bin/v-add-dns-record
                issue="0 issue \"letsencrypt.org\"";
                mailt="0 iodef \"mailto:$data_mail\"";
                $($VESTA/bin/v-add-dns-record "$user" "$domain" "$domain" "CAA" "$issue")
                $($VESTA/bin/v-add-dns-record "$user" "$domain" "$domain" "CAA" "$mailt")
        fi;
fi;
# define the global Vars
VESTA_USER="$user"
DOMAIN="$domain"

# force them to the global scope
export VESTA_USER
export DOMAIN

#proceed with execution

#TESTING API
#$VESTA/acme/acme.sh --issue -d "$domain" -d "$aliases" --dns dns_vesta --dnssleep 5 --debug 3 --log --staging --force --test -f

#REAL DEAL
$VESTA/acme/acme.sh --issue -d "$domain" -d "$aliases" --dns dns_vestacp --dnssleep 120 \
--cert-file "$USER_DATA/ssl/$domain.crt" --key-file "$USER_DATA/ssl/$domain.key" --ca-file "$USER_DATA/ssl/$domain.ca" --fullchain-file "$USER_DATA/ssl/$domain.pem" \
> /dev/null # Ignore the output sended from acme.

# Adding certificate to user dir
cp -f $USER_DATA/ssl/$domain.crt $HOMEDIR/$user/conf/web/ssl.$domain.crt
cp -f $USER_DATA/ssl/$domain.key $HOMEDIR/$user/conf/web/ssl.$domain.key
cp -f $USER_DATA/ssl/$domain.pem $HOMEDIR/$user/conf/web/ssl.$domain.pem
if [ -e "$USER_DATA/ssl/$domain.ca" ]; then
    cp -f $USER_DATA/ssl/$domain.ca $HOMEDIR/$user/conf/web/ssl.$domain.ca
fi

# Updating letsencrypt key
if [ -z "$LETSENCRYPT" ]; then
    add_object_key "web" 'DOMAIN' "$domain" 'LETSENCRYPT' 'FTP_USER'
fi
update_object_value 'web' 'DOMAIN' "$domain" '$LETSENCRYPT' 'wildcat'

# Adding LE-wildcat autorenew cronjob
if [ -z "$(grep v-update-letsencrypt-ssl-wildcat $VESTA/data/users/admin/cron.conf)" ]; then
    min=$(generate_password '012345' '2')
    hour=$(generate_password '1234567' '1')
    cmd="sudo $VESTA/bin/v-update-letsencrypt-ssl-wildcat"
    $VESTA/bin/v-add-cron-job admin "$min" "$hour" '*' '*' '*' "$cmd" > /dev/null
fi
#----------------------------------------------------------#
#                       Vesta                              #
#----------------------------------------------------------#

# Increasing domain value
increase_user_value "$user" '$U_DNS_DOMAINS'
increase_user_value "$user" '$U_DNS_RECORDS' "$records"

# Restart named
$VESTA/bin/v-restart-dns $restart
check_result $? "DNS restart failed"

# Logging
log_history "added dns domain $domain"
log_event "$OK" "$ARGUMENTS"

# Restarting web
$VESTA/bin/v-restart-web $restart
if [ "$?" -ne 0  ]; then
    send_notice 'LETSENCRYPT' "web server needs to be restarted manually"
fi

# Deleteing task from queue
touch $VESTA/data/queue/letsencrypt.pipe
sed -i "/ $domain /d" $VESTA/data/queue/letsencrypt.pipe

# Logging
log_event "$OK" "$ARGUMENTS"

exit
